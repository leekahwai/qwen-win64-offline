name: Build Win64 Qwen Offline Bundle
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest  # Windows x64 runner
    steps:
      - uses: actions/checkout@v4

      - name: Install Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Prepare offline bundle
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          cd qwen-offline

          # 1) Create a dedicated npm cache folder
          New-Item -ItemType Directory -Force -Path npm-cache | Out-Null

          # 2) Install deps (also generates package-lock.json)
          #    This populates our local cache for offline installs later
          npm install --cache ./npm-cache

          # 3) Pack the top-level Qwen Code CLI tarball
          npm pack @qwen-code/qwen-code@0.2.0

          # 4) Download Node.js MSI for the OFFLINE x64 machine
          $nodeVersion = "20.17.0"
          $nodeMsi = "node-v$nodeVersion-x64.msi"
          Invoke-WebRequest -Uri "https://nodejs.org/dist/v$nodeVersion/$nodeMsi" -OutFile $nodeMsi

          # 5) Stage outputs
          New-Item -ItemType Directory -Force -Path out | Out-Null
          # Zip npm-cache and node_modules (Windows 'tar' can be flaky)
          Compress-Archive -Path npm-cache -DestinationPath out/npm-cache.zip -Force
          Compress-Archive -Path node_modules -DestinationPath out/node_modules.zip -Force

          # Move artifacts (quote paths to avoid glob quirks)
          Get-ChildItem -Filter "*.tgz" | ForEach-Object { Move-Item -LiteralPath $_.FullName -Destination "out\" }
          Move-Item -LiteralPath $nodeMsi -Destination "out\"

          # Also include package.json and package-lock.json for reference
          Copy-Item package.json out\
          if (Test-Path package-lock.json) { Copy-Item package-lock.json out\ }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: qwen-win64-offline-bundle
          path: qwen-offline/out/**
 