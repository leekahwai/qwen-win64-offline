      - name: Prepare offline bundle (warm full cache, tarball-seed, and verify)
        shell: pwsh
        working-directory: qwen-offline
        run: |
          Set-StrictMode -Version Latest

          # --- Make sure npm is ONLINE on the runner ---
          npm config delete offline 2>$null
          $env:NPM_CONFIG_OFFLINE = $null
          npm config set registry "https://registry.npmjs.org/"
          npm config set fetch-retries 4
          npm config set fetch-timeout 60000

          # 1) Dedicated cache folder we'll ship
          New-Item -ItemType Directory -Force -Path npm-cache | Out-Null

          # 2) Local install -> creates lockfile & warms cache for local deps
          npm install --cache ./npm-cache --no-audit --no-fund

          # 3) Simulate the same GLOBAL install you'll do offline
          npm install -g @qwen-code/qwen-code@0.2.0 --cache ./npm-cache --no-audit --no-fund

          # 4) Seed by TARBALL (not just cache add), for packages that often cause ENOTCACHED
          function Seed-From-Tarball {
            param([string]$pkg)
            Write-Host "Seeding (tarball) $pkg ..."
            $ver = (npm view $pkg version) 2>$null
            if (-not $ver) { $ver = "latest" }
            $dist = (npm view "$pkg@$ver" dist.tarball) 2>$null
            if (-not $dist) {
              Write-Host "No dist.tarball from registry; trying npm pack..."
              npm pack "$pkg@$ver"
              $tgz = Get-ChildItem -Filter "*.tgz" | Where-Object { $_.Name -match ([Regex]::Escape($pkg.Split('/')[-1])) } | Select-Object -First 1
              if ($tgz) {
                npm cache add $tgz.FullName --cache ./npm-cache
                Remove-Item -LiteralPath $tgz.FullName -Force
              } else {
                Write-Error "Could not obtain tarball for $pkg@$ver"
                exit 1
              }
            } else {
              $name = "$($pkg.Split('/')[-1]).tgz"
              Invoke-WebRequest -Uri $dist -OutFile $name
              npm cache add ".\$name" --cache ./npm-cache
              Remove-Item ".\$name" -Force
            }
          }

          # These three are the usual suspects; adjust if the error names a different pkg
          Seed-From-Tarball "tiktoken"
          Seed-From-Tarball "@dqbd/tiktoken"
          Seed-From-Tarball "openai"

          # 5) Verify with a REAL offline install test using only our cache
          function Test-Offline-Install {
            param([string]$pkg)
            Write-Host "Testing offline install of $pkg ..."
            if (Test-Path .tmp-offline) { Remove-Item -Recurse -Force .tmp-offline }
            New-Item -ItemType Directory -Force -Path .tmp-offline | Out-Null
            Push-Location .tmp-offline
            npm init -y | Out-Null
            npm config set cache "../npm-cache"
            npm install "$pkg" --offline --no-audit --no-fund
            $ok = $LASTEXITCODE -eq 0
            Pop-Location
            Remove-Item -Recurse -Force .tmp-offline
            if (-not $ok) {
              Write-Error "Package '$pkg' not installable offline from cache."
              exit 1
            }
          }

          Test-Offline-Install "tiktoken"
          Test-Offline-Install "@dqbd/tiktoken"
          Test-Offline-Install "openai"

          # 6) Pack the Qwen Code CLI tarball for the target
          npm pack @qwen-code/qwen-code@0.2.0

          # 7) Optional: Node MSI (skip if you use the portable Node zip on target)
          $nodeVersion = "20.17.0"
          $nodeMsi = "node-v$nodeVersion-x64.msi"
          Invoke-WebRequest -Uri "https://nodejs.org/dist/v$nodeVersion/$nodeMsi" -OutFile $nodeMsi

          # 8) Zip outputs (avoid tar on Windows)
          New-Item -ItemType Directory -Force -Path out | Out-Null
          Compress-Archive -Path npm-cache      -DestinationPath out/npm-cache.zip    -Force
          Compress-Archive -Path node_modul_
